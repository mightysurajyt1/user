<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Arena</title>
    <style>
        :root {
            --light-bg: #f8f9fa;
            --light-surface: #ffffff;
            --light-text: #212529;
            --light-primary: #007bff;
            --light-secondary: #6c757d;
            --light-glow: 0 0 15px rgba(0, 123, 255, 0.5);

            --dark-bg: #121212;
            --dark-surface: #1e1e1e;
            --dark-text: #e0e0e0;
            --dark-primary: #4dabf7;
            --dark-secondary: #909296;
            --dark-glow: 0 0 15px rgba(77, 171, 247, 0.6);

            --bg: var(--light-bg);
            --surface: var(--light-surface);
            --text: var(--light-text);
            --primary: var(--light-primary);
            --secondary: var(--light-secondary);
            --glow: var(--light-glow);
            --border-color: #dee2e6;
        }

        html.dark {
            --bg: var(--dark-bg);
            --surface: var(--dark-surface);
            --text: var(--dark-text);
            --primary: var(--dark-primary);
            --secondary: var(--dark-secondary);
            --glow: var(--dark-glow);
            --border-color: #495057;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }

        /* --- Header & Nav --- */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: var(--surface); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .theme-switcher { cursor: pointer; font-size: 1.5rem; }
        .auth-buttons button, .user-menu button { background: none; border: none; font-size: 1rem; cursor: pointer; color: var(--text); }
        .btn-primary { padding: 10px 18px; background-color: var(--primary); color: white; border-radius: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); box-shadow: var(--glow); transition: all 0.2s ease-in-out; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4); }
        .user-menu { position: relative; }
        .dropdown { display: none; position: absolute; right: 0; top: 120%; background-color: var(--surface); min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; }
        .dropdown a { color: var(--text); padding: 12px 16px; text-decoration: none; display: block; }
        .dropdown a:hover { background-color: var(--bg); }
        .user-menu:hover .dropdown { display: block; }

        /* --- View Sections --- */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Slider --- */
        .slider-container { width: 100%; max-width: 1200px; margin: 20px auto; aspect-ratio: 16/7; overflow: hidden; border-radius: 10px; }
        .slider { display: flex; height: 100%; transition: transform 0.5s ease-in-out; }
        .slide { min-width: 100%; height: 100%; }
        .slide img { width: 100%; height: 100%; object-fit: contain; background-color: #000; }
        
        /* --- Tournaments Grid --- */
        .tournaments-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px 0; }
        .tournament-card { background-color: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
        .tournament-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card-thumbnail { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .card-body { padding: 15px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .game-badge { font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; color: white; }
        .bgmi { background-color: #d13639; }
        .freefire { background-color: #ff8c00; }
        .card-title { font-size: 1.2rem; font-weight: 600; margin: 0; }
        .card-meta { display: flex; flex-wrap: wrap; gap: 15px; color: var(--secondary); font-size: 0.9rem; margin-bottom: 15px; }
        .card-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .detail-item { font-size: 0.95rem; }
        .detail-item strong { color: var(--text); }
        .card-footer { border-top: 1px solid var(--border-color); padding-top: 15px; display: flex; justify-content: space-between; align-items: center; }

        @media (max-width: 992px) { .tournaments-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) {
            .tournaments-grid { grid-template-columns: repeat(3, 1fr); /* Always 3 columns as requested */ }
            .card-title { font-size: 1rem; }
            .card-meta, .card-details { font-size: 0.8rem; }
        }

        /* --- Modal (Auth, Wallet, etc.) --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--surface); padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2rem; cursor: pointer; color: var(--secondary); }
        .modal h2 { text-align: center; margin-bottom: 20px; color: var(--primary); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--bg); color: var(--text); }
        .form-switch { text-align: center; margin-top: 20px; }
        .form-switch a { color: var(--primary); cursor: pointer; text-decoration: underline; }
        .alert { padding: 10px; margin-top: 15px; border-radius: 4px; text-align: center; display: none; }
        .alert-danger { background-color: #f8d7da; color: #721c24; }
        .alert-success { background-color: #d4edda; color: #155724; }

        /* Wallet & Profile Styles */
        .wallet-info { text-align: center; margin-bottom: 20px; }
        .wallet-balance { font-size: 2.5rem; font-weight: bold; color: var(--primary); }
        #wallet-history { list-style: none; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; }
        #wallet-history li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        #wallet-history li:last-child { border-bottom: none; }
        .transaction-credit { color: #2ecc71; }
        .transaction-debit, .transaction-refund { color: #e74c3c; } /* Refund is money back, so should be a nice color */
        html.dark .transaction-credit { color: #40c057; }
        html.dark .transaction-debit, html.dark .transaction-refund { color: #ff6b6b; }
        
        /* Room Credentials & Results */
        .content-card { background-color: var(--surface); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .credentials-box { border: 2px dashed var(--primary); padding: 20px; text-align: center; margin-top: 20px; }
        .cred-item { margin: 10px 0; }
        .cred-item span { font-size: 1.2rem; font-weight: bold; background-color: var(--bg); padding: 5px 10px; border-radius: 5px; }
        .copy-btn { margin-left: 10px; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: var(--bg); }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">BattleArena</div>
        <nav class="nav-right">
            <div id="auth-buttons" style="display: none;">
                <button id="login-btn">Login</button>
                <button id="signup-btn" class="btn-primary">Sign Up</button>
            </div>
            <div id="user-menu" class="user-menu" style="display: none;">
                <button id="user-greeting">Hi, User!</button>
                <div class="dropdown">
                    <a href="#" id="profile-btn">Profile & Wallet</a>
                    <a href="#" id="logout-btn">Logout</a>
                </div>
            </div>
            <div class="theme-switcher" id="theme-switcher">‚òÄÔ∏è</div>
        </nav>
    </header>

    <main class="container">
        <!-- Home View (Slider + Tournaments) -->
        <div id="home-view" class="view active">
            <div class="slider-container">
                <div class="slider" id="slider"></div>
            </div>
            <h2>Upcoming Tournaments</h2>
            <div class="tournaments-grid" id="tournaments-grid">
                <!-- Tournament cards will be injected here by JS -->
                <p id="no-tournaments-msg" style="display:none;">No upcoming tournaments right now. Check back later!</p>
            </div>
        </div>

        <!-- Tournament Details View -->
        <div id="tournament-detail-view" class="view">
            <!-- Details will be loaded here -->
        </div>

        <!-- Results View -->
        <div id="results-view" class="view">
             <div class="content-card">
                <h2>Results & Leaderboards</h2>
                <div class="form-group">
                    <label for="result-tournament-select">Filter by Tournament:</label>
                    <select id="result-tournament-select"></select>
                </div>
                 <div class="form-group">
                    <label for="search-player">Search by Player/Team:</label>
                    <input type="text" id="search-player" placeholder="Enter name...">
                </div>
                <div style="overflow-x: auto;">
                    <table id="leaderboard-table">
                        <thead><tr><th>Rank</th><th>Player/Team</th><th>Kills</th><th>Placement</th><th>Total</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="auth-close-btn">&times;</span>
            <!-- Login Form -->
            <form id="login-form" style="display: none;">
                <h2>Login</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn-primary" style="width:100%;">Login</button>
                <div class="alert alert-danger" id="login-error"></div>
                <p class="form-switch">Don't have an account? <a id="show-signup">Sign Up</a></p>
            </form>
            <!-- Signup Form -->
            <form id="signup-form" style="display: none;">
                <h2>Sign Up</h2>
                <div class="form-group"><label for="signup-name">Display Name</label><input type="text" id="signup-name" required></div>
                <div class="form-group"><label for="signup-email">Email</label><input type="email" id="signup-email" required></div>
                <div class="form-group"><label for="signup-contact">Contact Number</label><input type="tel" id="signup-contact" required></div>
                <div class="form-group"><label for="signup-password">Password</label><input type="password" id="signup-password" required></div>
                <button type="submit" class="btn-primary" style="width:100%;">Create Account</button>
                <div class="alert alert-danger" id="signup-error"></div>
                <p class="form-switch">Already have an account? <a id="show-login">Login</a></p>
            </form>
        </div>
    </div>
    
    <!-- Profile & Wallet Modal -->
    <div id="wallet-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="wallet-close-btn">&times;</span>
            <h2>My Profile & Wallet</h2>
            <div class="wallet-info">
                <p>Current Balance</p>
                <div class="wallet-balance" id="wallet-balance">‚Çπ0.00</div>
            </div>
             <form id="add-money-form">
                <div class="form-group">
                    <label for="amount">Amount to Add (‚Çπ)</label>
                    <input type="number" id="amount" min="1" required placeholder="e.g., 100">
                </div>
                <p style="font-size:0.8rem; text-align:center; margin-bottom:10px;">You will be redirected to PhonePe UPI.</p>
                <button type="submit" class="btn-primary" style="width:100%;">Add Money</button>
            </form>
            <hr style="margin: 20px 0; border-color: var(--border-color);">
            <h3>Withdraw Money</h3>
            <form id="withdraw-money-form">
                <div class="form-group">
                    <label for="withdraw-amount">Amount to Withdraw (‚Çπ)</label>
                    <input type="number" id="withdraw-amount" min="50" required placeholder="e.g., 100">
                </div>
                <div class="form-group">
                    <label for="upi-id">UPI ID</label>
                    <input type="text" id="upi-id" required placeholder="yourname@upi">
                </div>
                <button type="submit" class="btn-primary" style="width:100%;">Request Withdrawal</button>
                <div class="alert" id="withdraw-message" style="display: none;"></div>
            </form>
            <hr style="margin: 20px 0; border-color: var(--border-color);">
            <h3>Transaction History</h3>
            <ul id="wallet-history">
                <li>No transactions yet.</li>
            </ul>
        </div>
    </div>
    
    <!-- Registration Confirmation Modal -->
    <div id="reg-confirm-modal" class="modal">
        <div class="modal-content">
             <h2>Confirm Registration</h2>
             <p>Register for <b id="confirm-tourney-title">Tournament</b>?</p>
             <p>Entry Fee: <b id="confirm-entry-fee">‚Çπ0</b></p>
             <p>This will be deducted from your wallet.</p>
             <div style="display:flex; gap: 10px; margin-top: 20px;">
                <button id="cancel-reg-btn" class="btn-primary" style="flex:1; background: var(--secondary);">Cancel</button>
                <button id="confirm-reg-btn" class="btn-primary" style="flex:1;">Confirm & Pay</button>
             </div>
             <div class="alert" id="reg-message"></div>
        </div>
    </div>


    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD8TSxu8tSupRs136PPCCP7C7lxbI5t8ro",
          authDomain: "kill-karo-pro.firebaseapp.com",
          databaseURL: "https://kill-karo-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "kill-karo-pro",
          storageBucket: "kill-karo-pro.appspot.com",
          messagingSenderId: "583311964637",
          appId: "1:583311964637:web:67398aec579de31f929e34",
          measurementId: "G-LJ82ZYN507"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- GLOBAL STATE & CACHE ---
        let currentUser = null;
        let tournamentsCache = {};
        
        // --- THEME SWITCHER ---
        const themeSwitcher = document.getElementById('theme-switcher');
        const html = document.documentElement;
        const savedTheme = localStorage.getItem('theme') || 'light';

        if (savedTheme === 'dark') {
            html.classList.add('dark');
            themeSwitcher.textContent = 'üåô';
        } else {
            themeSwitcher.textContent = '‚òÄÔ∏è';
        }

        themeSwitcher.addEventListener('click', () => {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                themeSwitcher.textContent = '‚òÄÔ∏è';
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeSwitcher.textContent = 'üåô';
            }
        });

        // --- UI & MODAL MANAGEMENT ---
        const authModal = document.getElementById('auth-modal');
        const walletModal = document.getElementById('wallet-modal');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');

        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        document.getElementById('login-btn').addEventListener('click', () => {
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
            openModal(authModal);
        });
        document.getElementById('signup-btn').addEventListener('click', () => {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            openModal(authModal);
        });
        document.getElementById('profile-btn').addEventListener('click', () => openModal(walletModal));
        
        document.getElementById('auth-close-btn').addEventListener('click', () => closeModal(authModal));
        document.getElementById('wallet-close-btn').addEventListener('click', () => closeModal(walletModal));
        
        document.getElementById('show-signup').addEventListener('click', () => {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        });
        document.getElementById('show-login').addEventListener('click', () => {
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
        });
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            const authButtons = document.getElementById('auth-buttons');
            const userMenu = document.getElementById('user-menu');
            if (user) {
                currentUser = user;
                authButtons.style.display = 'none';
                userMenu.style.display = 'flex';
                const userGreeting = document.getElementById('user-greeting');
                // Fetch user profile to get display name
                const userRef = ref(db, `users/${user.uid}`);
                get(userRef).then(snapshot => {
                    if(snapshot.exists()) {
                        const userData = snapshot.val();
                        userGreeting.textContent = `Hi, ${userData.displayName}`;
                        updateWalletUI(userData.walletBalance);
                        loadWalletHistory(user.uid);
                    }
                });
            } else {
                currentUser = null;
                authButtons.style.display = 'flex';
                userMenu.style.display = 'none';
            }
            // Re-render tournaments to show/hide register buttons
            renderTournaments();
        });

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const displayName = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const contactNumber = document.getElementById('signup-contact').value;
            const password = document.getElementById('signup-password').value;
            const errorDiv = document.getElementById('signup-error');

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    // Create user profile in Realtime Database
                    set(ref(db, 'users/' + user.uid), {
                        displayName,
                        email,
                        contactNumber,
                        walletBalance: 0,
                        createdAt: new Date().toISOString()
                    }).then(() => {
                        closeModal(authModal);
                    });
                })
                .catch(error => {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                });
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            signInWithEmailAndPassword(auth, email, password)
                .then(() => closeModal(authModal))
                .catch(error => {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                });
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- SLIDER ---
        const slider = document.getElementById('slider');
        let currentSlide = 0;
        function loadSlider() {
            const sliderRef = ref(db, 'slider');
            onValue(sliderRef, (snapshot) => {
                slider.innerHTML = '';
                const slides = snapshot.val() ? Object.values(snapshot.val()) : [];
                if (slides.length > 0) {
                    slides.forEach(slideData => {
                        slider.innerHTML += `
                            <div class="slide">
                                <a href="${slideData.redirectUrl}" target="_blank">
                                    <img src="${slideData.imageUrl}" alt="Announcement">
                                </a>
                            </div>
                        `;
                    });
                    
                    // Auto-slide logic
                    setInterval(() => {
                        currentSlide = (currentSlide + 1) % slides.length;
                        slider.style.transform = `translateX(-${currentSlide * 100}%)`;
                    }, 4000);
                }
            });
        }
        
        // --- TOURNAMENTS ---
        const tournamentsGrid = document.getElementById('tournaments-grid');
        function loadTournaments() {
            const tournamentsRef = ref(db, 'tournaments');
            onValue(tournamentsRef, (snapshot) => {
                tournamentsCache = snapshot.val() || {};
                renderTournaments();
            });
        }

        function renderTournaments() {
            tournamentsGrid.innerHTML = '';
            const upcomingTournaments = Object.entries(tournamentsCache).filter(([id, t]) => t.status === 'upcoming');
            
            if (upcomingTournaments.length === 0) {
                 document.getElementById('no-tournaments-msg').style.display = 'block';
            } else {
                 document.getElementById('no-tournaments-msg').style.display = 'none';
            }

            upcomingTournaments.forEach(([id, t]) => {
                const spotsLeft = t.maxPlayers - (t.registrations ? Object.keys(t.registrations).length : 0);
                const card = `
                    <div class="tournament-card">
                        <img src="${t.thumbnailUrl}" alt="${t.title}" class="card-thumbnail">
                        <div class="card-body">
                            <div class="card-header">
                                <span class="game-badge ${t.game.toLowerCase().replace(' ', '')}">${t.game}</span>
                                <h3 class="card-title">${t.title}</h3>
                            </div>
                            <div class="card-meta">
                                <span>${t.mode}</span> | <span>${t.perspective}</span> | <span>${t.map}</span>
                            </div>
                            <div class="card-details">
                                <div class="detail-item">Prize: <strong>‚Çπ${t.prizePool}</strong></div>
                                <div class="detail-item">Entry: <strong>‚Çπ${t.entryFee}</strong></div>
                                <div class="detail-item">Date: <strong>${new Date(t.dateTime).toLocaleDateString()}</strong></div>
                                <div class="detail-item">Time: <strong>${new Date(t.dateTime).toLocaleTimeString()}</strong></div>
                            </div>
                            <div class="card-footer">
                                <span>Spots Left: <strong>${spotsLeft > 0 ? spotsLeft : 'Full'}</strong></span>
                                ${currentUser && spotsLeft > 0 ? `<button class="btn-primary" onclick="handleRegistration('${id}')">Register</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                tournamentsGrid.innerHTML += card;
            });
            renderTournamentDetailView();
        }

        // --- REGISTRATION ---
        const regConfirmModal = document.getElementById('reg-confirm-modal');
        const confirmTitle = document.getElementById('confirm-tourney-title');
        const confirmFee = document.getElementById('confirm-entry-fee');
        let currentTournamentIdForReg = null;

        window.handleRegistration = async (tournamentId) => {
            if (!currentUser) {
                alert('Please login to register.');
                return;
            }
            // Check if already registered
            const regCheckRef = ref(db, `registrations/${tournamentId}/${currentUser.uid}`);
            const regSnapshot = await get(regCheckRef);
            if(regSnapshot.exists()){
                alert("You have already registered for this tournament.");
                return;
            }

            currentTournamentIdForReg = tournamentId;
            const tournament = tournamentsCache[tournamentId];
            confirmTitle.textContent = tournament.title;
            confirmFee.textContent = `‚Çπ${tournament.entryFee}`;
            openModal(regConfirmModal);
        };
        
        document.getElementById('cancel-reg-btn').addEventListener('click', () => closeModal(regConfirmModal));
        
        document.getElementById('confirm-reg-btn').addEventListener('click', async () => {
            const tournament = tournamentsCache[currentTournamentIdForReg];
            const userRef = ref(db, `users/${currentUser.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();

            if (userData.walletBalance >= tournament.entryFee) {
                // Atomic wallet deduction
                const walletRef = ref(db, `users/${currentUser.uid}/walletBalance`);
                await runTransaction(walletRef, (currentBalance) => {
                    if (currentBalance < tournament.entryFee) {
                        return; // Abort transaction
                    }
                    return currentBalance - tournament.entryFee;
                });

                // Create registration entry
                const regRef = ref(db, `registrations/${currentTournamentIdForReg}/${currentUser.uid}`);
                await set(regRef, {
                    leaderName: userData.displayName,
                    contactNumber: userData.contactNumber,
                    playerIDs: [userData.displayName], // Example for Solo
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                
                // Log transaction
                const txnRef = push(ref(db, `walletTransactions/${currentUser.uid}`));
                await set(txnRef, {
                    type: 'debit',
                    amount: tournament.entryFee,
                    description: `Entry fee for ${tournament.title}`,
                    timestamp: new Date().toISOString()
                });

                document.getElementById('reg-message').className = 'alert alert-success';
                document.getElementById('reg-message').textContent = 'Registration successful! Your status is pending approval.';
                document.getElementById('reg-message').style.display = 'block';

                setTimeout(() => {
                    closeModal(regConfirmModal);
                    document.getElementById('reg-message').style.display = 'none';
                }, 3000);

            } else {
                document.getElementById('reg-message').className = 'alert alert-danger';
                document.getElementById('reg-message').textContent = 'Insufficient Balance! Please add money to your wallet.';
                document.getElementById('reg-message').style.display = 'block';
            }
        });


        // --- WALLET SYSTEM ---
        function updateWalletUI(balance) {
            document.getElementById('wallet-balance').textContent = `‚Çπ${(balance || 0).toFixed(2)}`;
        }
        
        document.getElementById('add-money-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = document.getElementById('amount').value;
            if(amount < 1) return;
            // Simulate PhonePe UPI deep link
            const upiLink = `upi://pay?pa=your-upi-id@ybl&pn=BattleArena&am=${amount}&cu=INR`;
            // For a real app, you would use a web SDK or redirect. Here we simulate the process.
            alert(`Opening PhonePe to pay ‚Çπ${amount}. After payment, please upload transaction details.`);
            
            // In a real scenario, after payment, the user would provide a transaction ID.
            // We will create a "pending" transaction for the admin to approve.
            const transactionId = prompt("Please enter your UPI Transaction ID for verification:");
            if (transactionId && currentUser) {
                const pendingTxnRef = push(ref(db, 'pendingWalletTransactions'));
                set(pendingTxnRef, {
                    uid: currentUser.uid,
                    amount: parseFloat(amount),
                    transactionId: transactionId,
                    timestamp: new Date().toISOString(),
                    // screenshotUrl would be handled by Firebase Storage in a full app
                }).then(() => {
                    alert('Your request has been submitted and is pending verification.');
                    closeModal(walletModal);
                });
            }
        });

        document.getElementById('withdraw-money-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const withdrawAmount = parseFloat(document.getElementById('withdraw-amount').value);
            const upiId = document.getElementById('upi-id').value.trim();
            const messageDiv = document.getElementById('withdraw-message');

            const displayMessage = (message, isSuccess) => {
                messageDiv.textContent = message;
                messageDiv.className = isSuccess ? 'alert alert-success' : 'alert alert-danger';
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                    messageDiv.textContent = '';
                }, 4000);
            };

            if (!currentUser) {
                displayMessage('You must be logged in to make a withdrawal.', false);
                return;
            }

            if (isNaN(withdrawAmount) || withdrawAmount < 50) {
                displayMessage('Minimum withdrawal amount is ‚Çπ50.', false);
                return;
            }

            if (!upiId || !upiId.includes('@')) {
                displayMessage('Please enter a valid UPI ID.', false);
                return;
            }

            const userRef = ref(db, `users/${currentUser.uid}`);
            try {
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                const currentBalance = userData.walletBalance || 0;

                if (withdrawAmount > currentBalance) {
                    displayMessage('Insufficient wallet balance.', false);
                    return;
                }

                const withdrawalRef = push(ref(db, 'withdrawalRequests'));
                await set(withdrawalRef, {
                    uid: currentUser.uid,
                    displayName: userData.displayName,
                    amount: withdrawAmount,
                    upiId: upiId,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                });

                displayMessage('Withdrawal request submitted. It will be processed shortly.', true);
                document.getElementById('withdraw-money-form').reset();

            } catch (error) {
                console.error("Withdrawal Error: ", error);
                displayMessage('An error occurred. Please try again.', false);
            }
        });

        function loadWalletHistory(uid) {
            const historyRef = ref(db, `walletTransactions/${uid}`);
            onValue(historyRef, (snapshot) => {
                const historyList = document.getElementById('wallet-history');
                historyList.innerHTML = '';
                const txns = snapshot.val();
                if(txns) {
                    Object.values(txns).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(txn => {
                        const li = document.createElement('li');
                        const sign = txn.type === 'credit' || txn.type === 'refund' ? '+' : '-';
                        li.className = `transaction-${txn.type}`;
                        li.innerHTML = `
                            <span>${txn.description}</span>
                            <strong>${sign}‚Çπ${txn.amount}</strong>
                        `;
                        historyList.appendChild(li);
                    });
                } else {
                    historyList.innerHTML = '<li>No transactions yet.</li>';
                }
            });
        }
        
        // --- TOURNAMENT DETAIL, ROOM & RESULTS ---
        const detailView = document.getElementById('tournament-detail-view');

        function navigateToDetail(tournamentId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            detailView.classList.add('active');
            renderTournamentDetailView(tournamentId);
        }
        
        // Add event listener to grid that delegates clicks
        tournamentsGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.tournament-card');
            if (card && !e.target.matches('button')) {
                // Find the id from the button's onclick attribute (a bit of a hack)
                const button = card.querySelector('button[onclick]');
                if(button) {
                    const onclickAttr = button.getAttribute('onclick');
                    const tournamentId = onclickAttr.match(/'([^']+)'/)[1];
                    navigateToDetail(tournamentId);
                }
            }
        });

        async function renderTournamentDetailView(tournamentId) {
            if (!tournamentId) {
                 detailView.innerHTML = '';
                 return;
            }
            const tournament = tournamentsCache[tournamentId];
            if (!tournament) return;
            
            let roomInfoHtml = '<p>Room credentials will be revealed here after the reveal time.</p>';
            let registrationStatus = 'Not Registered';

            if(currentUser){
                const regRef = ref(db, `registrations/${tournamentId}/${currentUser.uid}`);
                const regSnapshot = await get(regRef);
                if(regSnapshot.exists()){
                    registrationStatus = `Registered (Status: ${regSnapshot.val().status})`;
                    if (regSnapshot.val().status === 'approved' && new Date() > new Date(tournament.roomRevealAt)) {
                        roomInfoHtml = `
                            <div class="credentials-box">
                                <h3>Room Credentials</h3>
                                <div class="cred-item">ID: <span>${tournament.roomId || 'Not set'}</span> <span class="copy-btn" onclick="copyToClipboard('${tournament.roomId}')">üìã</span></div>
                                <div class="cred-item">Pass: <span>${tournament.roomPass || 'Not set'}</span> <span class="copy-btn" onclick="copyToClipboard('${tournament.roomPass}')">üìã</span></div>
                            </div>
                        `;
                    }
                }
            }

            let resultsHtml = '';
            if (tournament.status === 'completed') {
                const resultsRef = ref(db, `results/${tournamentId}`);
                const resultsSnapshot = await get(resultsRef);
                if (resultsSnapshot.exists()) {
                     const results = Object.values(resultsSnapshot.val()).map(r => ({
                        ...r,
                        totalPoints: r.placementPoints + r.killPoints
                    })).sort((a, b) => b.totalPoints - a.totalPoints);
                    resultsHtml = `
                    <div class="content-card">
                        <h3>Leaderboard</h3>
                         <div style="overflow-x: auto;"><table><thead><tr><th>Rank</th><th>Player/Team</th><th>Kills</th><th>Placement</th><th>Total</th></tr></thead><tbody>
                         ${results.map((r, i) => `<tr><td>${i+1}</td><td>${r.teamName}</td><td>${r.killPoints}</td><td>${r.placementPoints}</td><td><b>${r.totalPoints}</b></td></tr>`).join('')}
                         </tbody></table></div>
                    </div>
                    `;
                }
            }

            detailView.innerHTML = `
                <button onclick="showHomeView()">‚Üê Back to Tournaments</button>
                <div class="content-card" style="margin-top:20px;">
                    <img src="${tournament.thumbnailUrl}" style="width:100%; border-radius:8px; margin-bottom: 20px;">
                    <h2>${tournament.title}</h2>
                    <p><strong>Status:</strong> ${tournament.status}</p>
                    <p><strong>Your Status:</strong> ${registrationStatus}</p>
                    <hr style="margin: 15px 0;">
                    <p>${tournament.rules || 'No specific rules provided.'}</p>
                    ${roomInfoHtml}
                </div>
                ${resultsHtml}
            `;
        }

        window.showHomeView = () => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('home-view').classList.add('active');
        };

        window.copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        };
        
        // --- INITIAL LOAD ---
        function init() {
            loadSlider();
            loadTournaments();
        }

        init();
    </script>

</body>
</html>